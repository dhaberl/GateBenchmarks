
Example associated with:
Phys Med Biol. 2019. Generative adversarial networks (GAN) for compact beam source modelling in Monte Carlo simulations [published online ahead of print, 2019 Aug 30]. 

Sarrut D, Krah N, Letang JM. 

Phys Med Biol. 2019;10.1088/1361-6560. doi:10.1088/1361-6560/ab3fc1 https://www.ncbi.nlm.nih.gov/pubmed/31470418

A method is proposed and evaluated to model large and inconvenient phase space files used in Monte Carlo simulations by a compact Generative Adversarial Network (GAN). The GAN is trained based on a phase space dataset to create a neural network, called Generator (G), allowing G to mimic the multidimensional data distribution of the phase space. At the end of the training process, G is stored with about 0.5 million weights, around 10 MB, instead of few GB of the initial file. Particles are then generated with G to replace the phase space dataset. This concept is applied to beam models from linear accelerators (linacs) and from brachytherapy seed models. Simulations using particles from the reference phase space on one hand and those generated by the GAN on the other hand were compared. 3D distributions of deposited energy obtained from source distributions generated by the GAN were close to the reference ones, with less than 1% of voxel-by-voxel relative difference. Sharp parts such as the brachytherapy emission lines in the energy spectra were not perfectly modeled by the GAN. Detailed statistical properties and limitations of the GAN-generated particles still require further investigation, but the proposed exploratory approach is already promising and paves the way for a wide range of applications.


# Installation

GAGA stands for GAN for GATE.

```
pip install gaga-phsp
```

The source code is https://github.com/dsarrut/gaga

The pypi project page is:  https://pypi.org/project/gaga

Note: you may also be interested in the GATE phsp tools that are included in the [GateTools](https://github.com/OpenGATE/GateTools/) package. 

**WARNING** GATE version with libtorch enabled is required. I will be officially release end 2019. In the meantime, use the branch named 'torch'. 

If you use [conda](https://docs.conda.io/en/latest/) or miniconda, here is the short set of commands to start an new environment:
```
conda create --name test_gaga
conda activate test_gaga
conda install pip
pip install gaga-phsp
```

# Learn a GAN phase-space

Consider an input a phase space in root file format. Training a GAN that will be able to reproduce the phase space is performed with ```gaga_train``` : 

```
gaga_train data/ELEKTA_PRECISE_6mv_part1.root pth/config_001.json pth/001.pth
```

A NVIDIA GPU card is required. It tooks about 1h20 of computation time on a NVIDIA Titan Xp (GP102-450-A1) with 12 GB memory. The json file contains the values of all hyperparameters. Some options are available, you can display them with ```gaga_train -h```. 

The output GAN information may be displayed with: ```gaga__info pth/001.pth```.

To be able to use the GAN from GATE, you need to convert into .pt/.json format with the following command:

```
gaga_convert_pth_to_pt pth/001.pth --no-gpu -k Z 271.1 -v
```

In GATE, the gpu is not (yet) supported, but the computation time is low here (about 5 sec for 1e6 generated particles). In this example, the Z value in the phase space is not learn because it is constant ; you should indicate the value to the conversion tool. Generated output files are: ```pth/001.pt``` and ```pth/001.json```.

You can have information about a PHSP file with the gatetools (GateTools)[https://github.com/OpenGATE/GateTools/] package:

```
gt_phsp_info data/ELEKTA_PRECISE_6mv_part1.root
gt_phsp_plot data/ELEKTA_PRECISE_6mv_part1.root
```


# Use the GAN within GATE

Use the macro commands like an usual phase space, but set the following options:

``` 
    /gate/source/addSource                          phsp_source phaseSpace
    /gate/source/phsp_source/addPhaseSpaceFile      data/pth/001.pt
    /gate/source/phsp_source/setParticleType        gamma
    /gate/source/phsp_source/setPytorchParams       data/pth/001_bis.json
    /gate/source/phsp_source/setPytorchBatchSize    1000000
    /gate/source/phsp_source/attachTo               phsp_vol
```

Note that .pt and .json file must be accessible in the data folder (you can use a link). 

The ```attachTo``` command indicates a volume name: the coordinate system of this volume will be used for all particles in the phase space. As a typical use, if you rotate the volume, the phase space will rotate. 

The batch size represent the number of particles that are generated at the same time. It depends on your memory.

A full example is provided:

```
    Gate mac/main.mac -a '[N,1e7] [JOB_ID,0] [TYPE,analog]'
    Gate mac/main.mac -a '[N,1e7] [JOB_ID,0] [TYPE,gaga]'
```

Note that the alias ```JOB_ID``` is required. If your run it with the gate job spliter, ```JOB_ID``` will allow to start in the phase space at different particle for all jobs. 

**WARNING** the phase space file of this example is not provided in this git repository (too large). You can find it here :    FIXME 

One computed, you can compare GAN and phase space.

The marginal distributions: 

```
gaga_plot -n 1e6 data/ELEKTA_PRECISE_6mv_part2.root pth/001.pth -b 300
```

```
./plot_err.py reference_data/results.ref.part1 -s 1 reference_data/results.ref.part2 -s 1 reference_data/results.gan.001 -s 1 -f 0
```
